<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Pembayaran - Miftahul Ulum</title>
    <script src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="Mid-client-LnUzaM8ZO6cHVLc-"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bg-nu-green { background-color: #006400; }
        .text-nu-green { color: #006400; }
        .border-nu-gold { border-color: #D4AF37; }
        .bg-nu-gold { background-color: #D4AF37; }
        .card-summary { transition: all 0.3s ease; }
        .card-summary:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="bg-green-50 min-h-screen font-sans text-slate-700">
    <div class="max-w-md mx-auto p-4">
        
        <div class="text-center py-6">
            <img src="logo-pesantren.png" alt="Logo" class="h-16 mx-auto mb-2" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Logo_Nahdlatul_Ulama.png/600px-Logo_Nahdlatul_Ulama.png';">
            <h1 class="text-xl font-black text-green-900 leading-tight uppercase">Pondok Pesantren<br>Miftahul Ulum</h1>
            <div class="h-1 w-12 bg-nu-gold mx-auto mt-2 rounded-full"></div>
        </div>

        <div id="login-box" class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-100">
            <div class="bg-nu-green p-4 text-white text-center">
                <h2 class="font-bold tracking-widest text-xs uppercase text-white">Portal Pembayaran Mandiri</h2>
            </div>
            
            <div class="p-8 space-y-5">
                <div>
                    <label class="block mb-1 text-[10px] font-black text-slate-400 uppercase">Nomor Induk Santri (ID)</label>
                    <input type="text" id="id_santri" class="w-full border-2 border-slate-100 p-3 rounded-2xl focus:border-nu-green outline-none transition text-center font-bold bg-slate-50 text-lg" placeholder="Masukkan ID Santri">
                </div>
                
                <div>
                    <label class="block mb-1 text-[10px] font-black text-slate-400 uppercase">PIN Keamanan</label>
                    <input type="password" id="pin_santri" class="w-full border-2 border-slate-100 p-3 rounded-2xl focus:border-nu-green outline-none transition text-center font-bold bg-slate-50 text-lg" placeholder="******">
                </div>
                
                <button onclick="checkBill()" id="btn-login" class="w-full bg-nu-green text-white font-bold py-4 rounded-2xl hover:bg-green-800 shadow-lg transition-all uppercase tracking-widest text-sm">
                    Cek Tagihan
                </button>
            </div>
        </div>

        <div id="bill-box" class="hidden space-y-4">
            <div class="bg-nu-green text-white p-5 rounded-3xl shadow-md border-b-4 border-nu-gold relative overflow-hidden">
                <div class="absolute -right-4 -top-4 opacity-10">
                    <svg class="w-24 h-24 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"></path></svg>
                </div>
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <p class="text-[10px] text-green-200 uppercase font-black tracking-widest">Wali Santri Dari:</p>
                        <h2 id="nama-santri" class="font-black text-xl leading-tight text-white">-</h2>
                        <div class="mt-2 flex gap-3 text-[10px]">
                            <span id="kelas-santri" class="bg-nu-gold text-nu-green px-2 py-0.5 rounded font-black uppercase tracking-tighter">KELAS -</span>
                            <span id="alamat-santri" class="italic opacity-80">-</span>
                        </div>
                    </div>
                    <button onclick="location.reload()" class="bg-green-900 text-white p-2 rounded-xl hover:bg-red-700 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-red-600">
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Total Tagihan</p>
                    <p id="summary-total" class="text-lg font-black text-slate-800">Rp 0</p>
                </div>
                <div id="status-card" class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-orange-500">
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Status</p>
                    <p id="summary-status" class="text-lg font-black text-orange-600 uppercase">Pending</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-xl border border-slate-100">
                <h3 class="font-bold text-nu-green mb-4 flex items-center gap-2 text-xs uppercase tracking-widest">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                    Rincian Tunggakan
                </h3>
                <div id="bill-list" class="space-y-2 mb-6 text-sm"></div>
                
                <div class="mt-4 pt-4 border-t-2 border-slate-50">
                    <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase text-center">Jumlah Pembayaran Online</label>
                    <div class="relative">
                        <span class="absolute left-4 top-3.5 font-bold text-nu-green">Rp</span>
                        <input type="number" id="pay_amount" class="w-full border-2 border-green-50 p-4 pl-12 rounded-2xl text-2xl font-black text-nu-green outline-none focus:border-nu-gold text-center bg-slate-50" placeholder="0">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 gap-3 mt-6">
                    <button onclick="payNow()" id="btn-pay" class="w-full bg-nu-green text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-green-800 transition-all uppercase tracking-widest text-sm">
                        Bayar Sekarang (Online)
                    </button>
                </div>
            </div>
        </div>

        <div class="text-center mt-10 pb-6">
            <p class="text-[10px] text-slate-400 font-bold tracking-widest uppercase">
                Â© 2026 <span style="text-transform: none !important; font-family: sans-serif;" class="text-green-800 font-black">pinggirX.com</span>
            </p>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbydcYzMBhI41iWWupzhxOszrTIhmKPwpuqAJzNLuGKG0MCDLI-1GxcljDmjaxGB4sQr/exec";

        async function checkBill() {
            const id = document.getElementById('id_santri').value;
            const pin = document.getElementById('pin_santri').value;
            const btn = document.getElementById('btn-login');
            if (!id || !pin) return alert("Isi ID dan PIN!");
            btn.innerText = "Memverifikasi..."; btn.disabled = true;

            try {
                const response = await fetch(`${API_URL}?action=login&id_santri=${id}&pin=${pin}`);
                const result = await response.json();
                
                if(result.status === "error") {
                    alert(result.msg);
                } else {
                    document.getElementById('login-box').classList.add('hidden');
                    document.getElementById('bill-box').classList.remove('hidden');
                    document.getElementById('nama-santri').innerText = result.nama;
                    document.getElementById('kelas-santri').innerText = "KELAS " + (result.kelas || "-");
                    document.getElementById('alamat-santri').innerText = result.alamat || "-";
                    
                    let html = "";
                    let totalTagihan = 0;

                    if (result.data.length === 0) {
                        html = `<div class="text-center p-6 bg-green-50 rounded-2xl border-2 border-dashed border-green-200 font-bold text-green-700 uppercase text-xs tracking-widest">Tagihan Lunas</div>`;
                        document.getElementById('pay_amount').disabled = true;
                        document.getElementById('summary-status').innerText = "Lunas";
                        document.getElementById('status-card').classList.replace('border-orange-500', 'border-green-600');
                    } else {
                        result.data.forEach(row => {
                            const nominal = Number(row[3]);
                            totalTagihan += nominal;
                            html += `<div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100"><div class="font-bold text-[11px] uppercase">${row[1]}</div><div class="font-black text-red-600">Rp ${nominal.toLocaleString()}</div></div>`;
                        });
                        document.getElementById('pay_amount').value = totalTagihan;
                    }
                    document.getElementById('summary-total').innerText = "Rp " + totalTagihan.toLocaleString();
                    document.getElementById('bill-list').innerHTML = html;
                }
            } catch (e) { alert("Kesalahan koneksi ke server."); }
            finally { btn.innerText = "CEK TAGIHAN"; btn.disabled = false; }
        }

        async function payNow() {
            const amount = document.getElementById('pay_amount').value;
            const id = document.getElementById('id_santri').value;
            const btnPay = document.getElementById('btn-pay');
            if(!amount || amount < 10000) return alert("Minimal Rp 10.000");
            btnPay.innerText = "Menghubungkan..."; btnPay.disabled = true;
            try {
                const resp = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'pay', id_santri: id, amount: amount }) });
                const snapData = await resp.json();
                if (snapData.token) {
                    window.snap.pay(snapData.token, {
                        onSuccess: function(result){ alert("Alhamdulillah, Berhasil!"); location.reload(); },
                        onPending: function(result){ alert("Segera selesaikan pembayaran."); },
                        onError: function(result){ alert("Pembayaran Gagal."); }
                    });
                } else { alert("Token pembayaran tidak valid."); }
            } catch (e) { alert("Sistem sedang sibuk."); }
            finally { btnPay.innerText = "BAYAR SEKARANG (ONLINE)"; btnPay.disabled = false; }
        }
    </script>
</body>
</html>

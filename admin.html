<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Miftahul Ulum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .bg-nu-green { background-color: #006400; }
        .text-nu-green { color: #006400; }
        .bg-nu-gold { background-color: #D4AF37; }
        body { background-color: #f8faf8; }
    </style>
</head>
<body class="min-h-screen font-sans text-slate-700">
    <div class="max-w-md mx-auto p-4">
        
        <div class="text-center py-6">
            <img src="logo-pesantren.png" class="h-16 mx-auto mb-2" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Logo_Nahdlatul_Ulama.png/600px-Logo_Nahdlatul_Ulama.png';">
            <h1 class="text-xl font-black text-green-900 leading-tight uppercase text-nu-green">Pondok Pesantren<br>Miftahul Ulum</h1>
            <div class="h-1 w-12 bg-nu-gold mx-auto mt-2 rounded-full"></div>
        </div>

        <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100 mb-6">
            <div class="bg-nu-green p-4 text-white text-center">
                <h2 class="font-bold tracking-widest text-xs uppercase">Sistem Bayar Cash</h2>
            </div>
            <div class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-3 text-center">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">PIN Admin</label>
                        <input type="password" id="admin_pin" class="w-full bg-slate-50 border-2 border-slate-100 p-2 rounded-xl text-center font-bold" placeholder="****">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Bendahara</label>
                        <select id="nama_bendahara" class="w-full bg-slate-50 border-2 border-slate-100 p-2 rounded-xl text-xs font-bold">
                            <option value="Bendahara 1">Bendahara 1</option>
                            <option value="Bendahara 2">Bendahara 2</option>
                        </select>
                    </div>
                </div>
                <div>
                    <div class="flex gap-2">
                        <input type="text" id="id_santri" class="flex-1 bg-yellow-50 border-2 border-yellow-100 p-3 rounded-2xl text-center font-bold text-lg" placeholder="ID SANTRI">
                        <button onclick="cariNama()" class="bg-nu-green text-white px-5 rounded-2xl text-[10px] font-bold uppercase">Cek</button>
                    </div>
                    <p id="display_nama" class="mt-2 text-center font-black text-nu-green text-sm h-5 italic"></p>
                </div>
                <div>
                    <input type="number" id="cash_amount" class="w-full border-2 border-slate-100 p-4 rounded-2xl text-2xl font-black text-nu-green text-center shadow-inner" placeholder="Nominal Rp">
                </div>
                <button onclick="prosesBayarCash()" id="btn-proses" class="w-full bg-nu-green text-white font-bold py-4 rounded-2xl uppercase tracking-widest text-sm shadow-lg hover:bg-green-800 transition-all">Simpan & Cetak Resi</button>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-lg overflow-hidden border border-slate-100 mb-6">
    <div class="bg-nu-green p-3 text-white text-center">
        <h3 class="text-[10px] font-black uppercase tracking-widest">Manajemen Laporan</h3>
    </div>
    
    <div class="p-6 space-y-5">
        <div class="space-y-2">
            <label class="block text-[9px] font-bold text-slate-400 uppercase tracking-tighter">Laporan Per Tanggal (Cetak PDF)</label>
            <div class="flex gap-2">
                <input type="date" id="filter_tgl" class="flex-1 border-2 border-slate-100 p-2 rounded-xl text-xs outline-none focus:border-nu-green">
                <button onclick="unduhLaporan('daily', 'pdf')" class="bg-nu-green text-white px-4 rounded-xl text-[9px] font-bold uppercase hover:bg-green-800 transition">Cetak</button>
            </div>
        </div>

        <div class="space-y-2">
            <label class="block text-[9px] font-bold text-slate-400 uppercase tracking-tighter">Laporan Per Bulan (Download Excel)</label>
            <div class="flex gap-2">
                <input type="month" id="filter_bln" class="flex-1 border-2 border-slate-100 p-2 rounded-xl text-xs outline-none focus:border-nu-gold">
                <button onclick="unduhLaporan('monthly', 'excel')" class="bg-nu-gold text-nu-green px-4 rounded-xl text-[9px] font-bold uppercase hover:opacity-80 transition text-nu-green">Excel</button>
            </div>
        </div>

        <hr class="border-slate-50">
        
        <button onclick="cekLaporanShift()" class="w-full bg-nu-green text-white font-bold py-3 rounded-xl text-[10px] uppercase tracking-widest shadow-md hover:bg-green-800 transition-all">
            Laporan Kas Shift Petugas
        </button>
    </div>
</div>

        <div class="text-center mt-10 pb-6">
            <p class="text-[10px] text-slate-400 font-bold tracking-widest uppercase">
                © 2026 <span style="text-transform: none !important; font-family: sans-serif;" class="text-green-800 font-black">pinggirX.com</span>
            </p>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbw6VXiM3bIAp8-9vsuXNyLB-6Qb9h_e4IAeV-RFvUyib4MIjykYt4UFYu_OSVeBTp-w/exec";
        const PIN_RAHASIA = "jirolupatma";
        let NAMA_SANTRI_GLOBAL = "";

        // Fungsi Cek Nama
        async function cariNama() {
            const id = document.getElementById('id_santri').value;
            if(!id) return alert("Isi ID Santri!");
            document.getElementById('display_nama').innerText = "Mencari...";
            try {
                const res = await fetch(`${API_URL}?action=login&id_santri=${id}&pin=ADMIN_BYPASS`);
                const data = await res.json();
                if(data.nama) { 
                    NAMA_SANTRI_GLOBAL = data.nama; 
                    document.getElementById('display_nama').innerText = data.nama; 
                } else { 
                    document.getElementById('display_nama').innerText = "ID TIDAK DITEMUKAN"; 
                }
            } catch(e) { document.getElementById('display_nama').innerText = "Gagal koneksi"; }
        }

        // Fungsi Simpan Bayar
        async function prosesBayarCash() {
            const pin = document.getElementById('admin_pin').value;
            const id = document.getElementById('id_santri').value;
            const amount = document.getElementById('cash_amount').value;
            const bendahara = document.getElementById('nama_bendahara').value;
            const btn = document.getElementById('btn-proses');

            if (pin !== PIN_RAHASIA) return alert("PIN ADMIN SALAH!");
            if (!NAMA_SANTRI_GLOBAL || !amount) return alert("Lengkapi data pembayaran!");

            if(!confirm(`Terima cash Rp ${Number(amount).toLocaleString()} dari ${NAMA_SANTRI_GLOBAL}?`)) return;

            btn.disabled = true; btn.innerText = "MENYIMPAN...";

            try {
                const res = await fetch(API_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ action: 'pay_cash', id_santri: id, amount: amount, bendahara: bendahara }) 
                });
                const data = await res.json();
                if(data.status === "success") { 
                    cetakStruk(id, NAMA_SANTRI_GLOBAL, amount, bendahara); 
                    location.reload(); 
                } else { alert("Gagal Simpan."); }
            } catch(e) { alert("Error sistem."); }
            finally { btn.disabled = false; btn.innerText = "Simpan & Cetak Resi"; }
        }

        // FUNGSI LAPORAN (Pusat Kendali Laporan)
        async function unduhLaporan(type, format) {
            const pin = document.getElementById('admin_pin').value;
            if (pin !== PIN_RAHASIA) return alert("Masukkan PIN Admin!");

            const filter = (type === 'daily') ? document.getElementById('filter_tgl').value : document.getElementById('filter_bln').value;
            if(!filter) return alert("Pilih Tanggal/Bulan!");
            
            try {
                const res = await fetch(`${API_URL}?action=report_${type}&filter=${filter}`);
                const data = await res.json();
                
                if(!data.detail || data.detail.length === 0) return alert("Tidak ada data transaksi cash.");

                if(format === 'pdf') { cetakLaporanPDF(data); }
                else { exportExcel(data, filter); }
            } catch(e) { alert("Gagal mengambil data laporan."); }
        }

        function exportExcel(res, filter) {
            const dataExcel = res.detail.map(d => ({ 
                "Tanggal": d.tgl, 
                "Waktu": d.waktu, 
                "ID Santri": d.id, 
                "Nominal": d.nominal, 
                "Bendahara": d.petugas 
            }));
            const ws = XLSX.utils.json_to_sheet(dataExcel);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Laporan " + filter);
            XLSX.writeFile(wb, `Laporan_Cash_${filter}.xlsx`);
        }

        function cetakLaporanPDF(res) {
            const win = window.open('', '_blank');
            let rows = res.detail.map(d => `<tr style="border-bottom:1px solid #eee"><td style="padding:5px">${d.waktu}</td><td>${d.id}</td><td align="right">Rp ${d.nominal.toLocaleString()}</td></tr>`).join('');
            win.document.write(`
                <html>
                <body onload="window.print()">
                    <center>
                        <h2 style="margin-bottom:0;color:#006400">LAPORAN PENERIMAAN CASH</h2>
                        <p style="margin-top:5px">Miftahul Ulum - Periode: ${res.filter}</p>
                        <table border="0" width="100%" style="border-collapse:collapse;font-size:12px">
                            <tr style="background:#006400;color:white"><th>JAM</th><th>ID SANTRI</th><th align="right">NOMINAL</th></tr>
                            ${rows}
                        </table>
                        <h3 align="right">TOTAL: Rp ${res.total.toLocaleString()}</h3>
                        <p style="font-size:9px;color:#888">Sistem SI-SANTRI • pinggirX.com</p>
                    </center>
                </body>
                </html>
            `);
            win.document.close();
        }

        async function cekLaporanShift() {
            const bnd = document.getElementById('nama_bendahara').value;
            const tgl = new Date().toISOString().split('T')[0];
            try {
                const res = await fetch(`${API_URL}?action=report_daily&filter=${tgl}&bendahara=${bnd}`);
                const data = await res.json();
                alert(`REKAP SHIFT HARI INI\n----------------------\nPetugas: ${bnd}\nTotal Uang Cash: Rp ${data.total.toLocaleString()}\n----------------------\nSilakan serah terima uang fisik.`);
            } catch(e) { alert("Gagal memuat rekap."); }
        }

        function cetakStruk(id, nama, amount, bendahara) {
            const tgl = new Date().toLocaleString('id-ID');
            const win = window.open('', '_blank');
            win.document.write(`<html><body onload="window.print();window.close()"><div style="width:250px;font-family:monospace;border:1px solid #eee;padding:15px;border-radius:10px;margin:auto"><center><strong style="color:#006400">MIFTAHUL ULUM</strong><br>RESI PEMBAYARAN TUNAI<hr style="border-top:1px dashed #ddd">ID: ${id}<br>Nama: ${nama}<br><strong style="font-size:16px">Rp ${Number(amount).toLocaleString()}</strong><hr style="border-top:1px dashed #ddd">Petugas: ${bendahara}<br>${tgl}<br><br><small>Syukron Jazakumullah<br>pinggirX.com</small></center></div></body></html>`);
            win.document.close();
        }
    </script>
</body>
</html>
